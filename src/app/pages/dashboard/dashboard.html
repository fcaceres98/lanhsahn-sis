<div class="dashboard-container">
    <!-- Header con refresh manual -->
    <mat-card class="dashboard-header">
        <mat-card-content class="dashboard-header-content">
            <div class="header-info">
                <h1 class="dashboard-title">Tablero de Graficos</h1>
                <div class="last-update">
                    <mat-icon>schedule</mat-icon>
                    <span>Última actualización: {{ formatLastUpdate() }}</span>
                </div>
            </div>
            
            <button matButton="filled" (click)="refreshData()" [disabled]="isRefreshing()" class="refresh-button">
                <mat-icon>refresh</mat-icon>
                {{ isRefreshing() ? 'Actualizando...' : 'Actualizar' }}
            </button>
        </mat-card-content>
    </mat-card>
    
    <!-- KPIs Section -->
    <div class="kpis-grid" [class.refreshing]="isRefreshing()">
        <mat-card class="kpi-card total">
            <mat-card-content>
                <div class="kpi-header">
                    <mat-icon>trending_up</mat-icon>
                    <span class="kpi-label">Total Hoy</span>
                </div>
                <div class="kpi-value">${{ totalToday.toFixed(2) }}</div>
            </mat-card-content>
        </mat-card>

        <mat-card class="kpi-card reservaciones">
            <mat-card-content>
                <div class="kpi-header">
                    <mat-icon>event_seat</mat-icon>
                    <span class="kpi-label">Reservaciones</span>
                </div>
                <div class="kpi-value">${{ totalReservaciones.toFixed(2) }}</div>
                <div class="kpi-percentage">{{ (totalReservaciones / totalToday * 100).toFixed(1) }}%</div>
            </mat-card-content>
        </mat-card>

        <mat-card class="kpi-card encomiendas">
            <mat-card-content>
                <div class="kpi-header">
                    <mat-icon>local_shipping</mat-icon>
                    <span class="kpi-label">Encomiendas</span>
                </div>
                <div class="kpi-value">${{ totalEncomiendas.toFixed(2) }}</div>
                <div class="kpi-percentage">{{ (totalEncomiendas / totalToday * 100).toFixed(1) }}%</div>
            </mat-card-content>
        </mat-card>

        <mat-card class="kpi-card penalidades">
            <mat-card-content>
                <div class="kpi-header">
                    <mat-icon>warning</mat-icon>
                    <span class="kpi-label">Penalidades</span>
                </div>
                <div class="kpi-value">${{ totalPenalidades.toFixed(2) }}</div>
                <div class="kpi-percentage">{{ (totalPenalidades / totalToday * 100).toFixed(1) }}%</div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <h2 class="section-title">Ventas por Usuario</h2>
        <div class="charts-grid" [class.refreshing]="isRefreshing()">
            @for (sales of userSalesData; track sales.id; let i = $index)
            {
                <mat-card class="chart-card">
                    <mat-card-header>
                        <mat-card-title>{{ sales.user }}</mat-card-title>
                        <mat-card-subtitle>Total: ${{ sales.total.toFixed(2) }}</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="chart-container">
                            <canvas [id]="'chart-' + i"></canvas>
                        </div>
                    </mat-card-content>
                </mat-card>
            }
        </div>
    </div>

    <!-- Recent Sales Section -->
    <div class="sales-section">
        <mat-card class="sales-card">
            <mat-card-header>
                <mat-card-title>
                    <mat-icon>receipt_long</mat-icon>
                    Últimas 10 Ventas
                </mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <table mat-table [dataSource]="recentSales" class="sales-table" [class.refreshing]="isRefreshing()">
                    <!-- Time Column -->
                    <ng-container matColumnDef="time">
                        <th mat-header-cell *matHeaderCellDef>Fecha y Hora</th>
                        <td mat-cell *matCellDef="let sale">
                            <div class="time-cell">
                                <div class="time">{{ formatTime(sale.date) }}</div>
                                <div class="date">{{ formatDate(sale.date) }}</div>
                            </div>
                        </td>
                    </ng-container>

                    <!-- User Column -->
                    <ng-container matColumnDef="user">
                        <th mat-header-cell *matHeaderCellDef>Usuario</th>
                        <td mat-cell *matCellDef="let sale">{{ sale.user }}</td>
                    </ng-container>

                    <!-- Type Column -->
                    <ng-container matColumnDef="type">
                        <th mat-header-cell *matHeaderCellDef>Tipo</th>
                        <td mat-cell *matCellDef="let sale">
                            <div class="type-badge" [ngClass]="getTypeClass(sale.type)">
                                <mat-icon>{{ getTypeIcon(sale.type) }}</mat-icon>
                                <span>{{ sale.type }}</span>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Amount Column -->
                    <ng-container matColumnDef="amount">
                        <th mat-header-cell *matHeaderCellDef>Monto</th>
                        <td mat-cell *matCellDef="let sale" class="amount-cell">
                            ${{ sale.amount.toFixed(2) }}
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
            </mat-card-content>
        </mat-card>
    </div>
</div>